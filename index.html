<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Fondo marino · Andrea Lértora</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
      background:
        radial-gradient(circle at 10% 0%, #3f7f82 0%, #0b3a3e 35%, #020e10 80%),
        linear-gradient(to bottom, #083234, #020b0d);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5f3ff;
    }

    .sea-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .7s ease-out, transform .7s ease-out;
    }
    .sea-container.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* ALGA BASE */
    .alga {
      position: absolute;
      pointer-events: none;
      object-fit: cover;
      transform-origin: 50% 100%;
      transform: translateZ(0);
    }
    .alga-bg { z-index: 0; }
    .alga-fg {
      z-index: 1;
      filter: saturate(.95);
      animation: corrientePuppet 12s ease-in-out infinite;
    }

    @keyframes corrientePuppet {
      0%   { transform: translateY(0) rotate(0deg) skewX(0deg); }
      25%  { transform: translateY(-6px) rotate(.4deg) skewX(1.2deg); }
      50%  { transform: translateY(-10px) rotate(.9deg) skewX(2.4deg); }
      75%  { transform: translateY(-5px) rotate(.3deg) skewX(1.0deg); }
      100% { transform: translateY(0) rotate(0deg) skewX(0deg); }
    }

    /* BLOQUE CENTRAL — TÍTULO Y BOTONES */
    .center-block {
      position: absolute;
      left: 8vw;
      top: 12vh;
      z-index: 2;
    }

    .name {
      display: inline-flex;
      gap: 0.25em;
      font-size: clamp(2.4rem, 4vw, 3.3rem);
      text-transform: uppercase;
      letter-spacing: .32em;
      margin-bottom: .2rem;
      color: #f9fafb;
      text-shadow: 0 1px 0 rgba(0,0,0,.7), 0 18px 40px rgba(0,0,0,.9);
    }
    .name span { display: inline-block; }

    .subtitle {
      font-size: .85rem;
      letter-spacing: .24em;
      color: #a5f3fc;
      margin-bottom: 1.3rem;
      text-transform: uppercase;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: .35rem;
    }

    .nav-button {
      width: 177px;
      padding: .20rem .75rem;
      border: none;
      border-radius: 3px;
      background-color: rgba(80,200,190,.35);
      mix-blend-mode: multiply;
      color: #e5f3ff;
      font-size: .7rem;
      letter-spacing: .18em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      cursor: pointer;
      box-shadow:
        0 2px 4px rgba(0,0,0,.35),
        0 0 0 1px rgba(15,23,42,.45);
      transition: background-color .18s, transform .13s,
                  box-shadow .18s, letter-spacing .13s;
    }

    .nav-button:hover {
      background-color: rgba(94,234,212,.42);
      transform: translateX(2px);
      letter-spacing: .20em;
      box-shadow: 0 6px 14px rgba(0,0,0,.55),
                  0 0 0 1px rgba(15,23,42,.65);
    }

    .nav-button:active {
      background-color: rgba(45,164,150,.52);
      transform: translateY(1px) scale(.99);
      box-shadow: 0 1px 3px rgba(0,0,0,.6),
                  0 0 0 1px rgba(15,23,42,.9);
    }

    /* PARTÍCULAS */
    .particles {
      position: absolute;
      inset: 0;
      z-index: 3;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      mix-blend-mode: multiply;
      opacity: 0.30;
      animation: particleCurrent ease-in-out infinite alternate;
    }

    @keyframes particleCurrent {
      0%   { transform: translate3d(0,0,0); }
      50%  { transform: translate3d(var(--driftX), var(--ampY), 0); }
      100% { transform: translate3d(0,0,0); }
    }

    .overlay {
      position: absolute;
      inset: 0;
      z-index: 4;
      pointer-events: none;
      background:
        radial-gradient(circle at 50% 15%, rgba(255,255,220,.08), transparent),
        linear-gradient(to bottom, rgba(10,35,45,.50), rgba(0,0,0,.75));
      mix-blend-mode: soft-light;
    }

    .grain {
      position: absolute;
      inset: 0;
      z-index: 5;
      opacity: .16;
      mix-blend-mode: soft-light;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 160 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.9'/%3E%3C/svg%3E");
    }

    /* BOTONES 30% MÁS GRANDES EN CELULARES / IPAD */
    @media (max-width: 768px) {
      .center-block {
        left: 6vw;
        top: 10vh;
      }

      .name {
        font-size: clamp(2rem, 6vw, 2.6rem);
        letter-spacing: .26em;
        flex-direction: column;
        gap: .05em;
      }

      .subtitle {
        font-size: .8rem;
        letter-spacing: .20em;
        margin-bottom: 1.1rem;
      }

      .nav-button {
        width: calc(177px * 1.3);
        padding: calc(.20rem * 1.3) calc(.75rem * 1.3);
        font-size: calc(.7rem * 1.3);
      }
    }

    /* ICONO DE SONIDO — 7% MÁS PEQUEÑO */
    #speakerIcon {
      position: fixed;
      bottom: 40px;
      right: 40px;
      width: min(6.51vw, 6.51vh);
      height: min(6.51vw, 6.51vh);
      min-width: 39px;
      min-height: 39px;
      max-width: 74px;
      max-height: 74px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 25px rgba(0,0,0,0.8);
      opacity: 0.85;
      transition: opacity 0.2s ease;
      z-index: 30;
      touch-action: none;
      user-select: none;
      -webkit-user-drag: none;
    }

    #speakerIcon:hover { opacity: .85; }
    #speakerIcon:active { transform: scale(.95); }

    /* Tintineo con fade elegante */
    @keyframes attentionBlink {
      0% { opacity: .55; }
      8% { opacity: 1; }
      16% { opacity: .35; }
      24% { opacity: 1; }
      32% { opacity: .35; }
      40% { opacity: 1; }
      100% { opacity: .55; }
    }
    #speakerIcon.muted { animation: attentionBlink 7s ease-in-out infinite; }
    #speakerIcon.active { animation: none; }

    #speakerIcon img {
      width: 70%;
      height: 70%;
      object-fit: contain;
      filter: drop-shadow(0 0 5px rgba(0,0,0,0.8));
      animation: huePulse 5.8s ease-in-out infinite alternate,
                 floatY 7.4s ease-in-out infinite;
      pointer-events: none;
      -webkit-user-drag: none;
    }

    #speakerIcon.active img {
      animation-duration: 4.8s, 6.2s;
    }
    #speakerIcon.muted img {
      animation-duration: 7.5s, 8.5s;
      opacity: 0.9;
    }

    @keyframes huePulse {
      0% { filter: hue-rotate(0deg) saturate(1) drop-shadow(0 0 5px rgba(0,0,0,.7)); }
      50% { filter: hue-rotate(12deg) saturate(1.25) drop-shadow(0 0 7px rgba(0,0,0,.9)); }
      100% { filter: hue-rotate(-10deg) saturate(1.1) drop-shadow(0 0 5px rgba(0,0,0,.7)); }
    }

    @keyframes floatY {
      0% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
      100% { transform: translateY(0); }
    }

    .ring {
      position: absolute;
      inset: -28%;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ring svg { width: 100%; height: 100%; }

    #ringCircle {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
      opacity: .9;
      transform-origin: 50% 50%;
      transform: rotate(-90deg);
      stroke: rgba(135,206,250,.7);
    }

    @keyframes ringColorShift {
      0% { stroke: rgba(135,206,250,.20); }
      25% { stroke: rgba(135,206,250,.85); }
      50% { stroke: rgba(173,216,230,.75); }
      75% { stroke: rgba(144,238,144,.65); }
      100% { stroke: rgba(135,206,250,.20); }
    }

    #speakerIcon.muted #ringCircle,
    #speakerIcon.active #ringCircle {
      animation: ringColorShift 12s ease-in-out infinite;
    }

    /* NIEBLA INFERIOR AZUL PROFUNDO */
    .bottom-fog {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 8vh;
      pointer-events: none;
      z-index: 20;
      background: linear-gradient(
        to top,
        rgba(3,18,40,1) 0%,
        rgba(3,18,40,1) 37%,
        rgba(3,18,40,0) 100%
      );
    }

    /* ANIMACIÓN ESCALONADA TÍTULO / SUBTÍTULO / BOTONES */
    @keyframes fadeDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .center-block .name,
    .center-block .subtitle,
    .center-block .nav-button {
      opacity: 0;
      transform: translateY(-10px);
    }

    .sea-container.visible .center-block .name {
      animation: fadeDown 0.65s ease-out forwards;
      animation-delay: 0.15s;
    }
    .sea-container.visible .center-block .subtitle {
      animation: fadeDown 0.65s ease-out forwards;
      animation-delay: 0.30s;
    }
    .sea-container.visible .center-block .nav-button:nth-child(1) {
      animation: fadeDown 0.55s ease-out forwards;
      animation-delay: 0.48s;
    }
    .sea-container.visible .center-block .nav-button:nth-child(2) {
      animation: fadeDown 0.55s ease-out forwards;
      animation-delay: 0.60s;
    }
    .sea-container.visible .center-block .nav-button:nth-child(3) {
      animation: fadeDown 0.55s ease-out forwards;
      animation-delay: 0.72s;
    }
    .sea-container.visible .center-block .nav-button:nth-child(4) {
      animation: fadeDown 0.55s ease-out forwards;
      animation-delay: 0.84s;
    }
  </style>
</head>

<body>
  <div class="sea-container" id="sea-container">

    <div class="center-block">
      <div class="name">
        <span class="first">Andrea</span>
        <span class="last">Lértora</span>
      </div>
      <div class="subtitle">artista plástica</div>

      <nav class="nav">
        <button class="nav-button">Bio</button>
        <button class="nav-button">Porta</button>
        <button class="nav-button">Cont</button>
        <button class="nav-button">Fun</button>
      </nav>
    </div>

    <div class="particles" id="particles-layer"></div>
    <div class="overlay"></div>
    <div class="grain"></div>
  </div>

  <!-- ICONO DE SONIDO -->
  <div id="speakerIcon" class="muted">
    <div class="ring">
      <svg viewBox="0 0 60 60">
        <circle id="ringCircle" cx="30" cy="30" r="24"></circle>
      </svg>
    </div>
    <img src="sonido/icono.png" alt="Audio marino" draggable="false">
  </div>

  <!-- NIEBLA INFERIOR -->
  <div class="bottom-fog"></div>

  <!-- SCRIPT FONDO MARINO -->
  <script>
    const algaeSources = [
      "algas/algas 1.png","algas/algas 2.png","algas/algas 3.png",
      "algas/algas 4.png","algas/algas 5.png"
    ];

    const container = document.getElementById("sea-container");
    const particlesContainer = document.getElementById("particles-layer");
    let bgImages = [], fgImages = [];
    let bgReady = false, fgReady = false, revealed = false;

    const random = (a,b) => a + Math.random()*(b-a);

    function getVH() {
      return window.innerHeight || document.documentElement.clientHeight || screen.height;
    }
    function getVW() {
      return window.innerWidth || document.documentElement.clientWidth || screen.width;
    }
    function isPortrait() {
      return getVH() > getVW();
    }

    function tryReveal() {
      if (bgReady && fgReady && !revealed) {
        revealed = true;
        container.classList.add("visible");
      }
    }

    /* helper: elegir PNG sin formar racimos del mismo archivo */
    function pickAlgaSrcNoCluster(prev1, prev2) {
      let candidates = algaeSources.filter(s => s !== prev1 && s !== prev2);
      if (!candidates.length) {
        candidates = algaeSources.filter(s => s !== prev1);
      }
      if (!candidates.length) {
        candidates = algaeSources.slice();
      }
      return candidates[Math.floor(Math.random() * candidates.length)];
    }

    function createSea() {
      container.querySelectorAll("img.alga").forEach(e => e.remove());
      bgImages = [];
      fgImages = [];
      bgReady = fgReady = revealed = false;
      container.classList.remove("visible");
      loadBG();
      loadFG();
    }

    /* FONDO (ALGAS DESENFOCADAS, SIN CORTARSE EN X) */
    function loadBG() {
      const baseCount = Math.floor(random(10,18));
      const factor = isPortrait() ? 0.5 : 1;
      const count = Math.max(3, Math.round(baseCount * factor));

      let done = 0;
      bgImages = [];

      let prev1 = null;
      let prev2 = null;

      for (let i = 0; i < count; i++) {
        const img = document.createElement("img");
        img.className = "alga alga-bg";

        const src = pickAlgaSrcNoCluster(prev1, prev2);
        img.src = src;
        prev2 = prev1;
        prev1 = src;

        img.style.opacity = random(.22,.40);
        img.style.filter  = `blur(${random(1.2,3.2)}px) saturate(.8)`;
        if (Math.random() < .5) img.style.transform = "scaleX(-1)";
        img.onload = () => { done++; if (done === count) layoutBG(); };
        bgImages.push(img);
        container.insertBefore(img, container.firstChild);
      }
    }

    function layoutBG() {
      if (!bgImages.length) return;

      const vh = getVH();
      const vw = getVW();

      const totalHeight = vh;
      const topOffset   = 0;

      const marginLeft  = vw * 0.03;
      const marginRight = vw * 0.03;

      const n = bgImages.length;
      const segments = n + 1;
      const segmentWidth = vw / segments;

      bgImages.forEach((img, index) => {
        const ratio = img.naturalWidth / img.naturalHeight || 0.4;
        let width   = totalHeight * ratio;
        const maxWidth = vw * 0.35;
        if (width > maxWidth) width = maxWidth;

        let center = (index + 1) * segmentWidth;
        let left   = center - width / 2;

        /* clamp para que nunca se corten en X */
        if (left < marginLeft) left = marginLeft;
        if (left + width > vw - marginRight) left = vw - marginRight - width;

        img.style.height = totalHeight + "px";
        img.style.width  = width + "px";
        img.style.top    = topOffset + "px";
        img.style.left   = left + "px";
      });

      bgReady = true;
      tryReveal();
    }

    /* FRENTE (ALGAS DELANTERAS) */
    function loadFG() {
      const baseCount = Math.floor(random(7,12));
      const factor = isPortrait() ? 0.5 : 1;
      const count = Math.max(3, Math.round(baseCount * factor));

      let done = 0;
      fgImages = [];

      let prev1 = null;
      let prev2 = null;

      for (let i = 0; i < count; i++) {
        const img = document.createElement("img");
        img.className = "alga alga-fg";

        const src = pickAlgaSrcNoCluster(prev1, prev2);
        img.src = src;
        prev2 = prev1;
        prev1 = src;

        img.style.opacity = random(.50,.78);
        if (Math.random() < .5) img.style.transform = "scaleX(-1)";
        img.onload = () => { done++; if (done === count) layoutFG(); };
        fgImages.push(img);
        container.insertBefore(img, container.querySelector(".overlay"));
      }
    }

    function layoutFG() {
      if (!fgImages.length) return;

      const vh = getVH();
      const vw = getVW();

      const totalHeight   = vh;
      const topOffset     = 0;
      const segments      = fgImages.length - 1 || 1;
      const segmentWidth  = vw / segments;

      fgImages.forEach((img, i) => {
        const ratio = img.naturalWidth / img.naturalHeight || 0.4;
        const width = totalHeight * ratio * 1.05;

        const center = i * segmentWidth + random(-segmentWidth * 0.15, segmentWidth * 0.15);
        const left   = center - width / 2;

        img.style.height = totalHeight + "px";
        img.style.width  = width + "px";
        img.style.top    = topOffset + "px";
        img.style.left   = left + "px";
      });

      fgReady = true;
      tryReveal();
    }

    /* PARTÍCULAS */
    function createParticles() {
      particlesContainer.innerHTML = "";

      const palette = [
        "rgba(200,230,240,0.40)",
        "rgba(180,210,220,0.38)",
        "rgba(160,200,210,0.34)",
        "rgba(140,180,190,0.32)"
      ];

      const totalParticles = 150;

      for (let i = 0; i < totalParticles; i++) {
        const p = document.createElement("div");
        p.className = "particle";

        const w = random(2, 10);
        const h = random(2, 10);
        p.style.width  = w + "px";
        p.style.height = h + "px";

        const r1 = random(40, 90);
        const r2 = random(40, 90);
        const r3 = random(40, 90);
        const r4 = random(40, 90);
        p.style.borderRadius = `${r1}% ${r2}% ${r3}% ${r4}%`;

        p.style.background = palette[Math.floor(Math.random() * palette.length)];

        if (Math.random() > 0.10) {
          p.style.filter = `blur(${random(0.5, 3)}px)`;
        }

        p.style.left = random(0, 100) + "vw";
        p.style.top  = random(0, 100) + "vh";

        p.style.setProperty("--driftX",  random(3, 10) + "vw");
        p.style.setProperty("--ampY",   random(-8, 8) + "px");  /* ← AQUÍ ESTABA EL PARÉNTESIS FALTANTE */

        p.style.animationDuration = random(14, 30) + "s";
        p.style.animationDelay    = random(-25, 0) + "s";

        particlesContainer.appendChild(p);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      createSea();
      createParticles();
    });

    window.addEventListener("resize", () => {
      layoutBG();
      layoutFG();
      createParticles();
    });

    window.addEventListener("orientationchange", () => {
      setTimeout(() => {
        layoutBG();
        layoutFG();
        createParticles();
      }, 300);
    });
  </script>

  <!-- SCRIPT DEL SONIDO -->
  <script>
    let audioCtx = null;
    let masterGain = null;
    let filter = null;

    let running = false;
    let userVolume = 0.45;
    const MIN_VOL = 0.12;
    const MAX_VOL = 0.7;

    let padTimeoutId = null;
    let leadOsc = null;
    let leadGain = null;
    let leadTimeoutId = null;
    let noiseSource = null;
    let noiseGain = null;
    let noiseFilter = null;
    let noiseTimeoutId = null;

    const bassRoot = 55;
    const pentatonicSteps = [0,2,4,7,9];

    const speakerIcon = document.getElementById("speakerIcon");
    const ringCircle = document.getElementById("ringCircle");
    let ringLength = 0;

    function randomPentatonicFreq() {
      const semis = 24 + pentatonicSteps[Math.floor(Math.random()*pentatonicSteps.length)];
      return bassRoot * Math.pow(2, semis/12);
    }

    /* FADE SUAVE GENERAL */
    function smoothFadeTo(targetValue, durationSeconds) {
      if (!audioCtx || !masterGain) return;
      const now = audioCtx.currentTime;
      const current = masterGain.gain.value;

      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(current, now);
      masterGain.gain.linearRampToValueAtTime(targetValue, now + durationSeconds);
    }

    function createContext() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0;

      filter = audioCtx.createBiquadFilter();
      filter.type = "lowpass";
      filter.frequency.value = 1000;
      filter.Q.value = 0.7;

      filter.connect(masterGain);
      masterGain.connect(audioCtx.destination);

      createBassLayer();
      startPadLoop();
      createLeadVoice();
      createNoiseLayer();

      smoothFadeTo(userVolume, 2.5);
    }

    function createBassLayer() {
      [bassRoot, bassRoot*1.2].forEach((f,i)=>{
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();

        osc.type = "sine";
        osc.frequency.value = f;

        g.gain.value = 0;
        osc.connect(g);
        g.connect(filter);

        g.gain.linearRampToValueAtTime(0.12 + i*0.03, audioCtx.currentTime + 5 + i*1.5);
        osc.start();
      });
    }

    function spawnPadNote() {
      if(!audioCtx) return;
      const base = [196,220,246.94,261.63,293.66][Math.floor(Math.random()*5)];
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      osc.type = Math.random()<0.5 ? "sine":"triangle";
      osc.frequency.value = base;

      g.gain.value = 0;
      osc.connect(g);
      g.connect(filter);

      const now = audioCtx.currentTime;
      const total = 1.4 + Math.random()*1.4;
      const fin = 0.3 + Math.random()*0.5;
      const fout = 0.4 + Math.random()*0.8;
      const sus = Math.max(0.2,total-fin-fout);
      const peak = 0.06 + Math.random()*0.05;

      g.gain.linearRampToValueAtTime(peak, now+fin);
      g.gain.linearRampToValueAtTime(peak, now+fin+sus);
      g.gain.linearRampToValueAtTime(0, now+total);

      osc.start();
      osc.stop(now+total+0.2);
    }

    function scheduleNextPad(){
      if(!running || !audioCtx) return;
      spawnPadNote();
      padTimeoutId = setTimeout(scheduleNextPad, 500+Math.random()*2000);
    }

    function startPadLoop(){
      setTimeout(()=>{
        if(running) scheduleNextPad();
      },800);
    }

    function createLeadVoice(){
      leadOsc = audioCtx.createOscillator();
      leadGain = audioCtx.createGain();
      leadOsc.type = "triangle";
      leadOsc.frequency.value = randomPentatonicFreq();
      leadGain.gain.value = 0;

      leadOsc.connect(leadGain);
      leadGain.connect(filter);

      leadGain.gain.linearRampToValueAtTime(0.03, audioCtx.currentTime+3);
      leadOsc.start();
      scheduleNextLeadStep();
    }

    function scheduleNextLeadStep(){
      if(!running || !audioCtx) return;
      const now = audioCtx.currentTime;
      leadOsc.frequency.setValueAtTime(randomPentatonicFreq(), now);

      const dur = 0.8 + Math.random()*2;
      const newGain = 0.02 + Math.random()*0.02;
      leadGain.gain.linearRampToValueAtTime(newGain, now + dur*0.5);

      leadTimeoutId = setTimeout(scheduleNextLeadStep, dur*1000);
    }

    function createNoiseLayer(){
      const buf = audioCtx.createBuffer(1, 2*audioCtx.sampleRate, audioCtx.sampleRate);
      const data = buf.getChannelData(0);
      for(let i=0;i<data.length;i++) data[i]=(Math.random()*2-1)*0.5;

      noiseSource = audioCtx.createBufferSource();
      noiseSource.buffer = buf;
      noiseSource.loop = true;

      noiseGain = audioCtx.createGain();
      noiseGain.gain.value = 0;

      noiseFilter = audioCtx.createBiquadFilter();
      noiseFilter.type = "bandpass";
      noiseFilter.frequency.value = 1500;

      noiseSource.connect(noiseFilter);
      noiseFilter.connect(noiseGain);
      noiseGain.connect(filter);

      noiseSource.start();

      /* ruido tipo televisor antiguo al ~60% del valor anterior */
      noiseGain.gain.linearRampToValueAtTime(0.024, audioCtx.currentTime+3);
      scheduleNextNoiseMod();
    }

    function scheduleNextNoiseMod(){
      if(!running || !audioCtx) return;
      const now = audioCtx.currentTime;
      const t = 2 + Math.random()*3;
      const base = 0.02 + Math.random()*0.05;
      const g = base * 0.6;

      noiseGain.gain.linearRampToValueAtTime(g, now+t);
      noiseTimeoutId = setTimeout(scheduleNextNoiseMod, t*1000);
    }

    function startSea(){
      if(running) return;
      running = true;
      speakerIcon.classList.remove("muted");
      speakerIcon.classList.add("active");

      if(!audioCtx || audioCtx.state==="closed"){
        createContext();
      } else if(audioCtx.state==="suspended"){
        audioCtx.resume();
        smoothFadeTo(userVolume, 2.0);
      } else {
        smoothFadeTo(userVolume, 2.0);
      }
    }

    function stopSea(){
      if(!running || !audioCtx) return;
      running = false;

      speakerIcon.classList.add("muted");
      speakerIcon.classList.remove("active");

      smoothFadeTo(0, 2.8);

      if(padTimeoutId){clearTimeout(padTimeoutId); padTimeoutId=null;}
      if(leadTimeoutId){clearTimeout(leadTimeoutId); leadTimeoutId=null;}
      if(noiseTimeoutId){clearTimeout(noiseTimeoutId); noiseTimeoutId=null;}

      setTimeout(()=>{
        if(audioCtx){
          audioCtx.close();
          audioCtx=null;
        }
      }, 3200);
    }

    function initRing(){
      const r = parseFloat(ringCircle.getAttribute("r"));
      ringLength = 2 * Math.PI * r;
      ringCircle.style.strokeDasharray = ringLength;
      updateVolumeVisual();
    }

    function updateVolumeVisual(){
      let ratio = (userVolume - MIN_VOL) / (MAX_VOL - MIN_VOL);
      ratio = Math.max(0,Math.min(1,ratio));
      ringCircle.style.strokeDashoffset = ringLength * (1-ratio);
    }

    function applyVolumeChange(){
      if(!audioCtx||!masterGain) return;
      smoothFadeTo(userVolume, 0.2);
      updateVolumeVisual();
    }

    let dragging=false;
    let lastY=0;
    let moved=false;
    let activePointerId=null;

    speakerIcon.addEventListener("dragstart", e => e.preventDefault());

    speakerIcon.addEventListener("pointerdown", e=>{
      if (e.pointerType === "mouse" && e.button !== 0) return;
      e.preventDefault();
      dragging=true;
      moved=false;
      lastY=e.clientY;
      activePointerId=e.pointerId;
      speakerIcon.setPointerCapture(e.pointerId);
    });

    speakerIcon.addEventListener("pointermove", e=>{
      if(!dragging || e.pointerId !== activePointerId) return;

      if (e.pointerType === "mouse" && !(e.buttons & 1)) {
        dragging=false;
        speakerIcon.releasePointerCapture(activePointerId);
        activePointerId=null;
        return;
      }

      const dy=e.clientY-lastY;
      if(Math.abs(dy)>2) moved=true;
      lastY=e.clientY;

      userVolume = Math.max(MIN_VOL, Math.min(MAX_VOL, userVolume - dy*0.002));
      applyVolumeChange();
    });

    function endPointer(e){
      if(!dragging || !activePointerId || e.pointerId !== activePointerId) return;
      e.preventDefault();
      dragging=false;
      speakerIcon.releasePointerCapture(e.pointerId);
      activePointerId=null;

      if(!moved){
        if(running) stopSea();
        else startSea();
      }
    }

    speakerIcon.addEventListener("pointerup", endPointer);
    speakerIcon.addEventListener("pointercancel", endPointer);

    window.addEventListener("load", ()=>{
      initRing();
    });
  </script>
</body>
</html>
